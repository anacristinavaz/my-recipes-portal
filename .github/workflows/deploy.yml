name: CD â€” Deploy to Staging / Production


on:
workflow_dispatch:
push:
branches: [ main ]


permissions:
contents: read
id-token: write


env:
REGISTRY: ghcr.io
IMAGE_NAMESPACE: ${{ github.repository_owner }}


jobs:
deploy-staging:
runs-on: ubuntu-latest
if: github.ref != 'refs/heads/main'
steps:
- name: Checkout
uses: actions/checkout@v4


- name: Kubernetes setup (kubectl & helm)
uses: azure/setup-kubectl@v3


- name: Deploy to Staging (Helm)
run: |
# placeholder: adjust kubeconfig via secrets
echo "Deploying to staging cluster..."
# helm upgrade --install ...


deploy-production:
runs-on: ubuntu-latest
needs: deploy-staging
if: github.ref == 'refs/heads/main'
environment:
name: production
url: https://your.prod.url
steps:
- name: Await approval
uses: chriscamacho/wait-for-approval@v1
with:
time: 7200
- name: Checkout
uses: actions/checkout@v4
- name: Setup kubectl & helm
uses: azure/setup-kubectl@v3
- name: Deploy to Production (Helm)
run: |
echo "Deploying to production cluster..."
# helm upgrade --install ...